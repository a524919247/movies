{% extends "base.html" %}
{% block content %}

<script src="/static/libs/jquery-validation-plugin/jquery.validate.min.js"></script>
<script src="/static/libs/jquery-validation-plugin/validate.messages_ru.js"></script>
<script>
    jQuery.validator.setDefaults({
        success: "valid"
    });;

    function displayMovie(movie) {
        html =  '<div class="result"><div class="poster"><img src="' + movie.poster + '" alt="' + movie.title + ' poster"/></div>' +
                '<div class="details">Название: ' + movie.title + '<br>';
        if (movie.release_date) {
            html += 'Дата выпуска: ' + movie.release_date;
        }
        html += '</div><div class="buttons"><input type="button" value="Смотрел" onclick="add_to_list_from_tmdb(' + movie.id + ', 1)" /> <input type="button" value="Хочу посмотреть" onclick="add_to_list_from_tmdb(' + movie.id + ', 2)" /></div></div>';
        $('#results').append(html);
    }

    function search_movie() {
        function isChecked(id) {
            if ($('#' + id).attr('checked')) {
                return 1
            } else {
                return 0
            }
        }

        $('#results').empty();
        popular_only = isChecked('popular_only');
        sort_by_date = isChecked('sort_by_date');
        options = {'popular_only': popular_only, 'sort_by_date': sort_by_date};

        $.post("{% url 'movies.views.ajax_search_movie' %}", {'query': $('#query').val(), 'type': $('input[name=type]:checked').val(), 'options': options },
            function(data) {
                if (data.status == 1) {
                    jQuery.each(data.movies, function(i, movie) {
                        displayMovie(movie);
                    });
                } else if (data.status == 0) {
                    $('#results').html('Ничего не найдено.');
                } else {
                    displayError('Ошибка поиска.');
                }
            }
        ).error(function() {
            displayError('Ошибка поиска.');
        });
    }

    function add_to_list_from_tmdb(movie_id, list_id) {
        $.post("{% url 'movies.views.ajax_add_to_list_from_tmdb' %}", {'movie_id': movie_id, 'list_id': list_id },
                function(data) {
                    if (data.status == -1) {
                        displayError('Ошибка! Код #1.');
                    }  else if (data.status == -2) {
                        displayError('Ошибка! Код #2.');
                    }
                }
            ).error(function() {
            displayError('Ошибка добавления фильма.');
        });
    }

    $(function() {
        $('#query').focus();
        $("#search").validate({
            rules: {
                query: "required"
            },
            submitHandler: function(form) {
                search_movie();
            },
            messages: {
                query: "Введите запрос.",
            },
            errorPlacement: function(error, element) {
                $('#error').html(error);
            }
        });
    });
</script>
<script src="/static/js/ajax_loading.js"></script>

<div class="search_panel">
    <form id="search">
        <input type="text" id="query" name="query" class="search_field"/>
        <input id="search_button" type="submit" value="Найти" /><br>
        <div>
            <input type="radio" name="type" value="1" checked>фильм
            <input type="radio" name="type" value="2">актер
            <input type="radio" name="type" value="3">режиссер<br>
            <input type="checkbox" id="popular_only" checked >отображать только популярные<br>
            <input type="checkbox" id="sort_by_date">сортировка по дате
        </div>
    </form>
<div id="error"></div>
</div>
<div id="loading" class="loading"></div>
<div id="results" class="results"></div>

{% endblock %}