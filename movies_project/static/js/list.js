// Generated by CoffeeScript 1.6.2
var activate_mode_minimal, apply_settings, change_rating, disactivate_mode_minimal, raty_custom_settings, remove_record, save_comment, switch_mode, switch_sort, toggle_comment_area, toggle_recommendation;

raty_custom_settings = {
  readOnly: raty_readonly,
  click: function(score) {
    if (!score) {
      score = 0;
    }
    return change_rating($(this).attr('data-record_id'), score, $(this));
  }
};

change_rating = function(id, rating, element) {
  var revert_to_previous_rating;

  revert_to_previous_rating = function(element) {
    var score_settings, settings;

    score_settings = {
      score: element.attr('data-rating')
    };
    settings = $.extend({}, raty_settings, raty_custom_settings, score_settings);
    return element.raty(settings);
  };
  return $.post(url_ajax_change_rating, {
    id: id,
    rating: rating
  }, function(data, error, x) {
    return element.attr('data-rating', rating);
  }).error(function() {
    revert_to_previous_rating(element);
    return displayError('Ошибка добавления оценки.');
  });
};

remove_record = function(id) {
  $.post(url_ajax_remove_record, {
    id: id
  }, function(data) {
    return remove_record_from_page(id);
  }).error(function() {
    return displayError('Ошибка добавления фильма.');
  });
  return void 0;
};

switch_mode = function(value) {
  var reload;

  reload = false;
  if (value === 'minimal') {
    if (mode === 'full') {
      reload = true;
    } else {
      activate_mode_minimal();
      this.mode = 'minimal';
    }
  } else if (value === 'compact' && mode === 'minimal') {
    disactivate_mode_minimal();
    this.mode = 'compact';
  } else {
    reload = true;
  }
  return apply_settings({
    mode: value
  }, reload);
};

switch_sort = function(value) {
  var additional_setting, settings;

  if (value !== 'rating') {
    additional_setting = {
      recommendation: false
    };
  } else {
    additional_setting = {};
  }
  settings = jQuery.extend({
    sort: value
  }, additional_setting);
  return apply_settings(settings);
};

apply_settings = function(settings, reload) {
  if (reload == null) {
    reload = true;
  }
  return $.post(url_ajax_apply_settings, {
    settings: JSON.stringify(settings)
  }, function(data) {
    if (reload) {
      return location.reload();
    }
  }).error(function() {
    return displayError('Ошибка применения настройки.');
  });
};

save_comment = function(id) {
  var comment;

  comment = $('#comment' + id).val();
  return $.post(url_ajax_save_comment, {
    id: id,
    comment: comment
  }, function(data) {
    if (!comment) {
      return toggle_comment_area(id);
    }
  }).error(function() {
    return displayError('Ошибка сохранения комментария.');
  });
};

toggle_comment_area = function(id) {
  $('#comment_area' + id).toggle();
  $('#comment_area_button' + id).toggle();
  return $('#comment' + id).focus();
};

activate_mode_minimal = function() {
  $('.poster, .comment, .release_date_label, .rating_label').hide();
  $('.details, .review').css('display', 'inline');
  $('.review').css('padding-top', '0');
  $('.release_date, .imdb_rating').css({
    float: 'right',
    'margin-right': '10px'
  });
  return $('.movie').css({
    'padding-top': '0',
    'margin-top': '7px',
    'min-height': 'auto'
  });
};

disactivate_mode_minimal = function() {
  $('.poster, .comment, .release_date_label, .rating_label').show();
  $('.details, .imdb_rating, .review, .release_date').css('display', '');
  $('.review').css('padding-top', '10px');
  $('.release_date, .imdb_rating').css({
    float: '',
    'margin-right': '0'
  });
  return $('.movie').css({
    'padding-top': '20px',
    'margin-top': '0',
    'min-height': '145px'
  });
};

toggle_recommendation = function() {
  if (recommendation) {
    return apply_settings({
      recommendation: false
    });
  } else {
    return apply_settings({
      sort: 'rating',
      recommendation: true
    });
  }
};

$(function() {
  var set_viewed_icons_and_remove_buttons;

  set_viewed_icons_and_remove_buttons = function() {
    if (anothers_account) {
      return $('.movie').each(function() {
        var id, list_id;

        id = $(this).attr('data-id');
        list_id = list_data[id];
        return set_viewed_icon_and_remove_buttons(id, list_id);
      });
    }
  };
  $('#button_mode_' + mode).button('toggle');
  if (mode === 'minimal') {
    activate_mode_minimal();
  }
  $('#button_sort_' + sort).button('toggle');
  if (recommendation) {
    $('#button_recommendation').button('toggle');
  }
  return set_viewed_icons_and_remove_buttons();
});
