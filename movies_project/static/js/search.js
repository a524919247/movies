// Generated by CoffeeScript 1.6.2
var add_to_list_from_db, change_search_type, displayMovie, search_movie, search_type;

search_type = 1;

jQuery.validator.setDefaults({
  success: 'valid'
});

displayMovie = function(movie) {
  var html;

  html = '<div class="movie" id="movie' + movie.id + '"><div class="poster"><img src="' + movie.poster + '" alt="' + movie.title + ' poster"/></div>\
              <div class="title">' + movie.title + '</div>' + '<div class="details">';
  if (movie.release_date) {
    html += '<strong>Дата выпуска:</strong> ' + movie.release_date + '</div>\
             <div class="buttons"><button type="button" title="Добавить в список &quot;Просмотрено&quot;"\
             class="btn" onclick="add_to_list_from_db(' + movie.id + ', 1)"><i class="icon-eye-open"></i></button>\
             <button type="button" title="Добавить в список &quot;К просмотру&quot;" class="btn" onclick="add_to_list_from_db(' + movie.id + ', 2)">\
             <i class="icon-eye-close"></i></button></div></div>';
  }
  return $('#results').append(html);
};

search_movie = function() {
  var isChecked, options, popular_only, sort_by_date;

  isChecked = function(id) {
    if ($('#' + id + ':checked').val()) {
      return 1;
    } else {
      return 0;
    }
  };
  $('#results').empty();
  popular_only = isChecked('popular_only');
  sort_by_date = isChecked('sort_by_date');
  options = {
    popular_only: popular_only,
    sort_by_date: sort_by_date
  };
  return $.post(url_ajax_search_movie, {
    query: $('#query').val(),
    type: search_type.toString(),
    options: options
  }, function() {
    if (data.status === 1) {
      return jQuery.each(data.movies, function(i, movie) {
        return displayMovie(movie);
      });
    } else if (data.status === 0) {
      return $('#results').html('Ничего не найдено.');
    } else {
      return displayError('Ошибка поиска.');
    }
  }).error(function() {
    return displayError('Ошибка поиска.');
  });
};

add_to_list_from_db = function(movie_id, list_id) {
  return $.post(url_ajax_add_to_list_from_db, {
    movie_id: movie_id,
    list_id: list_id
  }, function(data) {
    if (data.status === -1) {
      return displayError('Ошибка! Код #1.');
    } else if (data.status === -2) {
      return displayError('Ошибка! Код #2.');
    } else {
      return $('#movie' + movie_id).fadeOut('fast', function() {
        return $(this).remove();
      });
    }
  }).error(function() {
    return displayError('Ошибка добавления фильма.');
  });
};

change_search_type = function(id) {
  var text;

  if (id === 1) {
    text = 'Фильм';
    search_type = 1;
  }
  if (id === 2) {
    text = 'Актёр';
    search_type = 2;
  }
  if (id === 3) {
    text = 'Режиссёр';
    search_type = 3;
  }
  return $('#search_type_button').html(text + ' <span class="caret"></span>');
};

$(function() {
  $('#query').focus();
  return $('#search').validate({
    rules: {
      query: 'required'
    },
    messages: {
      query: 'Введите запрос.'
    },
    errorPlacement: function(error, element) {
      return $('#error').html(error);
    },
    submitHandler: function(form) {
      return search_movie();
    }
  });
});
